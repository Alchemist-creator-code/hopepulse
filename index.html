<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puls de Speranță v3.9.1 - Stabil</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #ffb347;
            --indigo: #1e1e4f;
            --purple: #4b0082;
            --accent: #ff8c00;
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Quicksand', sans-serif; 
            background: var(--indigo); 
        }

        .fixed-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 70% 30%, var(--accent) 0%, var(--purple) 40%, var(--indigo) 100%);
            z-index: -1;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; box-sizing: border-box;
            transition: opacity 0.8s ease;
        }

        #ui-layer { 
            justify-content: center; align-items: flex-start; 
            padding-left: 10%; z-index: 50; 
            background: rgba(0, 0, 0, 0.3);
        }
        
        #final-layer { 
            justify-content: center; align-items: center; text-align: center; 
            z-index: 100; display: none; opacity: 0; padding: 20px; 
            background: rgba(10, 0, 30, 0.9);
        }
        
        h1 { color: #fff; font-size: 3.5rem; margin: 0; font-weight: 600; text-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .instruction-text { color: var(--gold); font-size: 1.5rem; max-width: 600px; line-height: 1.4; margin: 20px 0 30px 0; font-weight: 600; }

        .input-group { display: flex; gap: 15px; margin-bottom: 25px; z-index: 60; }
        
        .bio-input {
            background: rgba(255, 255, 255, 0.2); border: 2px solid var(--gold);
            padding: 15px; border-radius: 15px; color: white; width: 140px;
            font-family: 'Quicksand', sans-serif; font-size: 1.1rem; outline: none;
        }

        #void-input {
            background: rgba(255, 255, 255, 0.15); border: none; border-bottom: 5px solid var(--gold);
            width: 85%; max-width: 500px; padding: 20px; font-size: 1.5rem; color: #fff; 
            font-family: 'Quicksand', sans-serif; outline: none; border-radius: 20px 20px 0 0;
            margin-bottom: 35px;
        }

        .btn { 
            padding: 20px 60px; background: var(--gold); color: #000; border: none; 
            border-radius: 60px; cursor: pointer; font-weight: 600; font-size: 1.4rem; 
            transition: 0.3s; box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            z-index: 70;
        }
        .btn:hover { transform: scale(1.05); background: #fff; }

        #stop-session { 
            position: absolute; top: 30px; right: 30px; z-index: 200; 
            background: rgba(255,255,255,0.2); color: white; border: 2px solid white; 
            padding: 12px 30px; border-radius: 40px; cursor: pointer; display: none; 
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none; }
        
        #message-box { font-size: 3rem; color: var(--gold); max-width: 900px; font-style: italic; margin-bottom: 40px; }
    </style>
</head>
<body>

    <div class="fixed-bg"></div>
    <canvas id="canvas"></canvas>

    <div id="ui-layer" class="screen">
        <h1>Puls de Speranță</h1>
        <p class="instruction-text">Scrie ce ai pe suflet. <br>Lăsăm cuvintele să devină lumină.</p>
        
        <div class="input-group">
            <input type="number" id="bp-input" class="bio-input" placeholder="Tensiune">
            <input type="number" id="hr-input" class="bio-input" placeholder="Puls">
        </div>

        <input type="text" id="void-input" placeholder="Ce eliberezi azi?" autocomplete="off">
        
        <button id="start-btn" class="btn">ÎNCEPE ACUM</button>
    </div>

    <button id="stop-session">Am terminat</button>

    <div id="final-layer" class="screen">
        <div id="message-box"></div>
        <p style="color: #fff; font-size: 1.5rem; margin-bottom: 45px;">Respiră. Totul va fi bine.</p>
        <button onclick="window.location.reload()" class="btn">REÎNCEPE</button>
    </div>

    <script>
        const messages = ["Această furtună va trece.", "Ești mai puternic decât crezi.", "Respiră, ești aici.", "Meriți liniște."];
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const input = document.getElementById('void-input');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-session');
        const uiLayer = document.getElementById('ui-layer');
        const finalLayer = document.getElementById('final-layer');

        let width, height, audioCtx, masterGain;
        let particles = [];
        let isRunning = false;
        let time = 0;
        let speedMultiplier = 1.0;

        function resize() { 
            width = canvas.width = window.innerWidth; 
            height = canvas.height = window.innerHeight; 
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor(x, y, text) {
                this.x = x; this.y = y; this.text = text;
                this.life = 1.0;
                this.fontSize = Math.floor(Math.random() * 20) + 50;
                this.speed = (Math.random() * 0.02 + 0.01);
            }
            update(tx, ty) {
                if (isRunning) {
                    this.x += (tx - this.x) * (this.speed * speedMultiplier);
                    this.y += (ty - this.y) * (this.speed * speedMultiplier);
                } else {
                    this.y -= 2;
                }
                this.life -= 0.006;
            }
            draw() {
                ctx.save();
                ctx.shadowBlur = 20; ctx.shadowColor = "#fff";
                ctx.fillStyle = `rgba(255, 255, 255, ${this.life})`;
                ctx.font = `bold ${this.fontSize}px 'Quicksand'`;
                ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
        }

        input.addEventListener('input', (e) => {
            if (e.data) {
                const rect = input.getBoundingClientRect();
                particles.push(new Particle(rect.left + rect.width/2, rect.top, e.data));
            }
        });

        function setupAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                masterGain = audioCtx.createGain();
                masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
                masterGain.connect(audioCtx.destination);
                
                [55, 110].forEach(f => {
                    let osc = audioCtx.createOscillator();
                    osc.frequency.value = f;
                    let g = audioCtx.createGain();
                    g.gain.value = 0.1;
                    osc.connect(g); g.connect(masterGain);
                    osc.start();
                });
                masterGain.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 3);
            } catch(e) { console.log("Audio error"); }
        }

        function animate() {
            ctx.clearRect(0, 0, width, height); 
            let emdrX = width / 2;
            let emdrY = height / 2;

            if (isRunning) {
                time += 0.012 * speedMultiplier;
                emdrX = width / 2 + Math.sin(time) * (width * 0.35);
                const grad = ctx.createRadialGradient(emdrX, emdrY, 0, emdrX, emdrY, 70);
                grad.addColorStop(0, '#fff'); grad.addColorStop(0.3, '#ffb347'); grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(emdrX, emdrY, 70, 0, Math.PI * 2); ctx.fill();
            }

            particles.forEach((p, i) => {
                p.update(emdrX, emdrY);
                p.draw();
                if (p.life <= 0) particles.splice(i, 1);
            });
            requestAnimationFrame(animate);
        }

        // LOGICA DE START REPARATĂ
        startBtn.addEventListener('click', () => {
            const bp = document.getElementById('bp-input').value;
            const hr = document.getElementById('hr-input').value;

            // Adaptare viteză (biofeedback)
            if ((bp && bp > 140) || (hr && hr > 100)) {
                speedMultiplier = 0.6; 
            } else {
                speedMultiplier = 1.0;
            }

            // Pornim audio IMEDIAT
            setupAudio();

            // Pornim sesiunea vizuală
            isRunning = true;
            uiLayer.style.opacity = '0';
            
            setTimeout(() => { 
                uiLayer.style.display = 'none'; 
                stopBtn.style.display = 'block';
            }, 800);
        });

        stopBtn.addEventListener('click', () => {
            isRunning = false;
            stopBtn.style.display = 'none';
            document.getElementById('message-box').innerText = messages[Math.floor(Math.random() * messages.length)];
            finalLayer.style.display = 'flex';
            setTimeout(() => { finalLayer.style.opacity = '1'; }, 50);
            if(masterGain) masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1);
        });

        animate();
    </script>
</body>
</html>